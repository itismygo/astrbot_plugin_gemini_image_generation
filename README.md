# AstrBot Gemini 图像生成插件 v1.6.5

<div align="center">

![Version](https://img.shields.io/badge/Version-v1.6.5-blue)
![License](https://img.shields.io/badge/License-MIT-orange)

</div>

**🎨 强大的 Gemini 图像生成插件，支持智能头像参考和智能表情包切分**

## ✨ 特性

### 🖼️ **核心功能**
- **生图模式**: 纯文本到图像生成，支持多种风格和参数
- **改图模式**: 基于参考图像进行修改和风格转换，支持配置化头像参考
- **换风格模式**: 专门的风格转换功能，支持配置化头像参考
- **智能头像参考**: 自动获取用户头像和@指定对象头像作为参考
- **多API支持**: 兼容 Google 官方 API 和 OpenAI 兼容格式 API
- **智能表情包切分 (全新升级)**: 
  - **黑线分割算法 (默认)**: 专为 Gemini 生成的 2x2 表情包设计，能够精确识别粗黑线、去除白色噪点，并自动标准化 4px 白边，确保切图干净无残留。
  - **智能网格**: 自动识别不规则网格布局。

### 🛡️ **限制/限流**
- **群限制模式**: 支持不限制/白名单/黑名单三种模式
- **群内限流**: 单群在指定周期内的请求次数限制
- **防滥用**: 有效防止API滥用和资源浪费

### 🧠 **智能特性**
- **自然语言触发**: 支持"按照我"、"修改"、"@人"等自然语言触发
- **智能优先级**: @用户 > 发言人
- **降级处理**: 自动处理参数兼容性问题
- **缓存机制**: 避免重复下载头像，提升性能
- **分辨率控制**: 支持 1K、2K、4K 分辨率
- **长宽比调整**: 支持多种常用比例（1:1, 16:9, 4:3, 9:16等）
- **Google 搜索接地**: 实时数据参考生成
- **智能重试**: 自动重试机制，提高成功率
- **主题配置**: 可配置的白天/黑夜主题自动切换

## 📦 安装

### 前置要求
- AstrBot 4.5.0+
- Python 3.8+
- NapCat (推荐) 或其他 OneBot 实现

### 安装步骤
1. 将插件文件夹放置到 `data/plugins/` 目录下
2. 确保 `astrbot_plugin_gemini_image_generation` 文件夹存在
3. 重启 AstrBot

## 🔧 配置

### 基础配置

在插件配置中设置以下参数：

- **api_settings.provider_id**: 生图模型提供商（`_special: select_provider`），自动读取模型/密钥/端点；不选将无法调用
- **api_settings.vision_provider_id**: 视觉识别提供商（可选，用于切图前 AI 识别网格行列；留空则不调用）
- **image_generation_settings.image_input_mode**: 参考图传输格式。`auto` 自动选择；`force_base64` 强制转为纯 base64。

### 关键配置项

**image_generation_settings**
- `resolution`：生成图像分辨率，默认 `1K`。
- `aspect_ratio`：长宽比，默认 `1:1`。
- `enable_sticker_split`：生图后是否自动切分表情包，默认 true。
- `enable_sticker_zip`：切分后是否打包 ZIP 发送，默认 false。
- `enable_grounding`：Gemini 搜索接地，默认 false。

**limit_settings**
- `group_limit_mode`：群限制模式 `none`/`whitelist`/`blacklist`。
- `enable_rate_limit`：是否开启群内限流。

## 🎯 使用指南

### ✂️ 切图功能 (重点更新)

插件内置了全新的切图算法，支持多种模式：

#### 1. 默认切图 (黑线分割)
直接发送图片并输入 `/切图`，插件将默认使用 **黑线分割算法**。
- **适用场景**: Gemini 生成的典型 2x2 表情包（中间有黑色十字线）。
- **算法优势**: 
  - **穿透式扫描**: 能忽略黑线周围的白色噪点，找到真正的黑边内侧。
  - **自动去黑边**: 强力切除四周黑框。
  - **标准化白边**: 自动识别内容最小包围盒，并统一添加 4px 白边，确保视觉统一且无残留。

```
[发送图片]
/切图
```

#### 2. 手动指定网格
如果图片是规则的网格但没有黑线，可以手动指定行列。
```
/切图 2x2
/切图 3 4
```

---

### 🎨 生图与改图

#### 生图模式
```
/生图 一只可爱的橙色小猫，坐在樱花树下，动漫风格
```

#### 改图模式
```
[发送图片]
/改图 把头发改成红色
```

#### 换风格
```
[发送图片]
/换风格 水彩 梦幻效果
```

#### 智能头像参考
- **自动获取**: 输入 "按照我生成..." 或 "根据我..." 会自动使用发送者的头像。
- **指定用户**: 输入 "/改图 @某人 ..." 会使用被 @ 用户的头像。

## 📝 常见问题

**Q: 切图后边缘有黑线残留怎么办？**
A: 新版算法已加入强制收缩机制（自动向内收缩 2px），通常能解决此问题。如果仍有残留，请检查图片背景是否纯黑或对比度过低。

**Q: 为什么生图失败提示 Unknown mimetype？**
A: 这通常是因为引用的图片链接（如 QQ 图片）没有标准后缀或防盗链导致 AI 无法下载。建议重新发送图片或使用本地图片。

**Q: 如何开启 AI 辅助切图？**
A: 在配置中设置 `vision_provider_id`，当默认算法无法识别时，会自动调用 AI 视觉模型进行网格检测。
